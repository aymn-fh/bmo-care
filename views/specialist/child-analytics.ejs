<%- include('../partials/layout-start', { title: `تحليلات ${child.name}`, activePage: 'children' }) %>

    <div class="page-container-blue">
        <!-- Blue Profile Header -->
        <div class="blue-profile-header">
            <div class="profile-content-wrapper">
                <!-- PDF Download (Far right in RTL) -->
                <a class="header-pdf-pill" href="/specialist/child/<%= child._id %>/analytics/pdf" aria-label="تنزيل تقرير تقدم الطفل PDF" title="تنزيل PDF">
                    <i class="fa-solid fa-file-pdf" aria-hidden="true"></i>
                </a>

                <!-- Stats Section (Left in RTL) -->
                <div class="header-stats-blue">
                    <div class="stat-item-blue">
                        <span class="stat-value" id="headerSuccessRate">--</span>
                        <span class="stat-label">نسبة النجاح</span>
                    </div>
                    <div class="stat-item-blue">
                        <span class="stat-value" id="headerAvgScore">--</span>
                        <span class="stat-label">متوسط الأداء</span>
                    </div>
                    <div class="stat-item-blue">
                        <span class="stat-value" id="headerTotalSessions">--</span>
                        <span class="stat-label">إجمالي الجلسات</span>
                    </div>
                </div>

                <!-- Profile Info (Right in RTL) -->
                <div class="header-info-blue">
                    <div class="info-details">
                        <h1 class="child-name">
                            <%= child.name %>
                        </h1>

                        <div class="header-parent-block">
                            <div class="header-parent-name">
                                <%= (child.parent && child.parent.name) ? child.parent.name : '-' %>
                            </div>
                            <div class="header-parent-email">
                                <%= (child.parent && child.parent.email) ? child.parent.email : '' %>
                            </div>
                        </div>
                    </div>

                    <!-- Child Avatar -->
                    <div class="avatar-circle-blue">
                        <%- include('../partials/child-avatar', { child: child, sizePx: 120 }) %>
                    </div>
                </div>
            </div>
        </div>


        <!-- Plan Settings + Numbered Sessions (Session 1/2/3...) -->
        <div class="secondary-grid-blue" style="margin-top: 1rem;">
            <div class="chart-box-white">
                <div class="chart-header-simple">
                    <h3><i class="fa-solid fa-calendar-check"></i> إعدادات اللعب</h3>
                    <span>مدة + جدول لعب (متى يلعب)</span>
                </div>

                <form method="POST" action="/specialist/child/<%= child._id %>/plan-settings" style="padding: 0 1rem 1rem;">
                    <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <div class="form-group">
                            <label>الحد اليومي (دقيقة)</label>
                            <input class="form-control" type="number" name="dailyPlayDuration" min="0" value="<%= (child.dailyPlayDuration != null ? child.dailyPlayDuration : '') %>">
                        </div>
                        <div class="form-group">
                            <label>مدة الجلسة (دقيقة)</label>
                            <input class="form-control" type="number" name="playDuration" min="1" value="<%= (child.sessionStructure && child.sessionStructure.playDuration != null) ? child.sessionStructure.playDuration : '' %>">
                        </div>
                        <div class="form-group">
                            <label>مدة الاستراحة (دقيقة)</label>
                            <input class="form-control" type="number" name="breakDuration" min="0" value="<%= (child.sessionStructure && child.sessionStructure.breakDuration != null) ? child.sessionStructure.breakDuration : '' %>">
                        </div>
                        <div class="form-group">
                            <label>أقصى عدد محاولات للجلسة</label>
                            <input class="form-control" type="number" name="maxAttempts" min="1" value="<%= (child.sessionStructure && child.sessionStructure.maxAttempts != null) ? child.sessionStructure.maxAttempts : '' %>">
                        </div>
                    </div>

                    <hr style="margin: 1rem 0; opacity: 0.2;"/>

                    <div class="form-group" style="display:flex; align-items:center; gap:0.5rem;">
                        <input type="checkbox" name="scheduleEnabled" id="scheduleEnabled" <%= (child.playSchedule && child.playSchedule.enabled) ? 'checked' : '' %> />
                        <label for="scheduleEnabled" style="margin:0;">تفعيل جدول اللعب</label>
                    </div>

                    <div class="form-group" style="margin-top: 0.75rem;">
                        <label>أيام السماح</label>
                        <% const days = [
                            { v: 0, t: 'الأحد' },
                            { v: 1, t: 'الإثنين' },
                            { v: 2, t: 'الثلاثاء' },
                            { v: 3, t: 'الأربعاء' },
                            { v: 4, t: 'الخميس' },
                            { v: 5, t: 'الجمعة' },
                            { v: 6, t: 'السبت' },
                        ];
                        const allowedRaw = (child.playSchedule && Array.isArray(child.playSchedule.allowedDays)) ? child.playSchedule.allowedDays : [];
                        const allowed = allowedRaw.map(x => Number(x)).filter(x => Number.isFinite(x));
                        %>
                        <div style="display:flex; flex-wrap:wrap; gap:0.75rem;">
                            <% days.forEach(d => { %>
                                <label style="display:flex; align-items:center; gap:0.35rem;">
                                    <input type="checkbox" name="allowedDays" value="<%= d.v %>" <%= allowed.includes(d.v) ? 'checked' : '' %> />
                                    <span><%= d.t %></span>
                                </label>
                            <% }); %>
                        </div>
                        <div style="margin-top:0.5rem; color:#64748b; font-size:0.85rem;">إذا لم يتم اختيار أيام، سيتم السماح بكل الأيام.</div>
                    </div>

                    <% const w0 = (child.playSchedule && Array.isArray(child.playSchedule.windows) && child.playSchedule.windows.length)
                        ? child.playSchedule.windows[0]
                        : null;
                    %>
                    <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.75rem;">
                        <div class="form-group">
                            <label>من</label>
                            <input class="form-control" type="time" name="windowStart" value="<%= (w0 && w0.start) ? w0.start : '' %>">
                        </div>
                        <div class="form-group">
                            <label>إلى</label>
                            <input class="form-control" type="time" name="windowEnd" value="<%= (w0 && w0.end) ? w0.end : '' %>">
                        </div>
                    </div>

                    <button class="btn btn-primary" type="submit" style="margin-top: 0.75rem; width: 100%;">حفظ</button>
                </form>
            </div>

            <div class="chart-box-white">
                <div class="chart-header-simple">
                    <h3><i class="fa-solid fa-layer-group"></i> جلسات الخطة (Session)</h3>
                    <span>سهولة البحث والمقارنة</span>
                </div>

                <div style="padding: 0 1rem 1rem;">
                    <div style="margin-bottom: 0.75rem; color:#64748b; font-size:0.9rem;">
                        الجلسة النشطة هي التي تُرسل رقمها مع كل تقدم من اللعبة.
                    </div>

                    <div style="max-height: 160px; overflow:auto; border: 1px solid rgba(15, 23, 42, 0.08); border-radius: 10px;">
                        <table class="clean-blue-table" style="margin:0;">
                            <thead>
                                <tr>
                                    <th>Session</th>
                                    <th>الاسم</th>
                                    <th>نشطة</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (!plans || plans.length === 0) { %>
                                    <tr><td colspan="3" style="text-align:center; color:#64748b;">لا توجد جلسات خطة بعد</td></tr>
                                <% } else { %>
                                    <% plans.forEach(p => { %>
                                        <tr>
                                            <td><%= p.sessionIndex != null ? p.sessionIndex : '-' %></td>
                                            <td><%= p.sessionName || '-' %></td>
                                            <td>
                                                <% if (p.active) { %>
                                                    <span style="color:#16a34a; font-weight:600;">نعم</span>
                                                <% } else { %>
                                                    <span style="color:#64748b;">لا</span>
                                                <% } %>
                                            </td>
                                        </tr>
                                    <% }); %>
                                <% } %>
                            </tbody>
                        </table>
                    </div>

                    <hr style="margin: 1rem 0; opacity: 0.2;"/>

                    <form method="POST" action="/specialist/child/<%= child._id %>/create-plan-session">
                        <div class="form-group">
                            <label>اسم الجلسة (اختياري)</label>
                            <input class="form-control" type="text" name="sessionName" placeholder="Session 1">
                        </div>
                        <div class="form-group" style="margin-top:0.5rem;">
                            <label>مدة الجلسة (دقيقة) (اختياري)</label>
                            <input class="form-control" type="number" name="targetDuration" min="1" placeholder="15">
                        </div>
                        <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.75rem;">
                            <div class="form-group">
                                <label>حروف (كل سطر حرف أو مفصول بفاصلة)</label>
                                <textarea class="form-control" name="lettersText" rows="6" placeholder="ب\nت\nث"></textarea>
                            </div>
                            <div class="form-group">
                                <label>كلمات (كل سطر كلمة أو مفصول بفاصلة)</label>
                                <textarea class="form-control" name="wordsText" rows="6" placeholder="بابا\nماما"></textarea>
                            </div>
                        </div>

                        <button class="btn btn-primary" type="submit" style="margin-top: 0.75rem; width: 100%;">إنشاء Session جديدة (وتفعيلها)</button>
                    </form>
                </div>
            </div>
        </div>


        <!-- Charts Grid -->
        <div class="charts-grid-blue-layout">
            <!-- Progress Over Time -->
            <div class="chart-box-white">
                <div class="chart-header-simple">
                    <h3>
                        <i class="fa-solid fa-arrow-trend-up"></i>
                        التقدم عبر الزمن
                    </h3>
                    <span>آخر 20 جلسة</span>
                </div>
                <div class="chart-wrapper-blue">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <!-- Skills Comparison -->
            <div class="chart-box-white">
                <div class="chart-header-simple">
                    <h3>
                        <i class="fa-solid fa-chart-bar"></i>
                        مقارنة المهارات
                    </h3>
                    <span>متوسط الأداء لكل نشاط</span>
                </div>
                <div class="chart-wrapper-blue">
                    <canvas id="skillsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Secondary Charts & Table Grid -->
        <div class="secondary-grid-blue">
            <!-- Success Rate -->
            <div class="chart-box-white small-box">
                <div class="chart-header-simple">
                    <h3>نسبة النجاح</h3>
                </div>
                <div class="chart-wrapper-small">
                    <canvas id="successChart"></canvas>
                </div>
                <div class="text-center" style="padding: 0.25rem 1rem 1rem; color: #64748b; font-size: 0.9rem;">
                    <span id="successSuccessful">--</span>
                    <span style="margin: 0 0.35rem;">/</span>
                    <span id="successTotal">--</span>
                    <span style="margin-right: 0.5rem;">محاولة ناجحة</span>
                </div>
            </div>

            <!-- Difficulty -->
            <div class="chart-box-white small-box">
                <div class="chart-header-simple">
                    <h3>توزيع الصعوبة (حروف / كلمات)</h3>
                </div>
                <div class="chart-wrapper-small">
                    <canvas id="difficultyChart"></canvas>
                </div>
            </div>

            <!-- Skills Table -->
            <div class="table-box-white span-2">
                <div class="chart-header-simple">
                    <h3>تفاصيل المهارات</h3>
                </div>
                <table class="clean-blue-table" id="skillsTable">
                    <thead>
                        <tr>
                            <th>المهارة</th>
                            <th>الجلسات</th>
                            <th>الأداء</th>
                            <th>التقدم</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4" class="text-center">جاري التحميل...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- EXTENDED DETAILS SECTION (Unified View) -->
    <div class="extended-details-section">
        <% if (progress) { %>
            <!-- LETTER PROGRESS -->
            <div class="clean-card">
                <div class="card-header-clean">
                    <h3><i class="fa-solid fa-font"></i> تقدم الحروف</h3>
                </div>
                <div class="card-body-clean">
                    <% if (progress.letterProgress && progress.letterProgress.length> 0) { %>
                        <div class="progress-items-grid">
                            <% progress.letterProgress.forEach(function(lp) { %>
                                <div class="progress-item <%= lp.mastered ? 'item-success' : 'item-pending' %>">
                                    <span class="item-char">
                                        <%= lp.letter %>
                                    </span>
                                    <div class="item-details">
                                        <%= lp.attempts || 0 %> محاولة | <%= Math.round((lp.successRate || 0) * 100) %>%
                                    </div>
                                </div>
                                <% }); %>
                        </div>
                        <% } else { %>
                            <div class="empty-placeholder">
                                <i class="fa-solid fa-font"></i>
                                <p>لم يتم تحديد حروف مستهدفة بعد</p>
                            </div>
                            <% } %>
                </div>
            </div>

            <!-- WORD PROGRESS -->
            <div class="clean-card">
                <div class="card-header-clean">
                    <h3><i class="fa-solid fa-book"></i> تقدم الكلمات</h3>
                </div>
                <div class="card-body-clean">
                    <% if (progress.wordProgress && progress.wordProgress.length> 0) { %>
                        <div class="progress-items-grid">
                            <% progress.wordProgress.forEach(function(wp) { %>
                                <div class="progress-item <%= wp.mastered ? 'item-success' : 'item-info' %>">
                                    <span class="item-char text-sm">
                                        <%= wp.word %>
                                    </span>
                                    <div class="item-details">
                                        <%= wp.attempts || 0 %> محاولة | <%= Math.round((wp.successRate || 0) * 100) %>%
                                    </div>
                                </div>
                                <% }); %>
                        </div>
                        <% } else { %>
                            <div class="empty-placeholder">
                                <i class="fa-solid fa-book"></i>
                                <p>لم يتم تحديد كلمات مستهدفة بعد</p>
                            </div>
                            <% } %>
                </div>
            </div>

            <!-- Final Word Analysis (latest session) -->
            <div class="clean-card">
                <div class="card-header-clean">
                    <h3><i class="fa-solid fa-magnifying-glass"></i> التحليل النهائي للكلمات (آخر جلسة)</h3>
                </div>
                <div class="card-body-clean">
                    <% if (typeof finalWordAnalysis !== 'undefined' && finalWordAnalysis && finalWordAnalysis.length > 0) { %>
                        <table class="clean-blue-table">
                            <thead>
                                <tr>
                                    <th>الكلمة/المستهدف</th>
                                    <th>النطق النهائي</th>
                                    <th>الدرجة</th>
                                    <th>المصدر</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% finalWordAnalysis.forEach(function(a) { %>
                                    <tr>
                                        <td><%= a.target || '-' %></td>
                                        <td><%= (a.recognizedText && a.recognizedText.trim()) ? a.recognizedText : '-' %></td>
                                        <td><%= (typeof a.score === 'number') ? Math.round(a.score) + '%' : '-' %></td>
                                        <td><%= a.analysisSource || '-' %></td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <div class="empty-placeholder">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <p>لا يوجد تحليل نهائي للكلمات في آخر جلسة</p>
                        </div>
                    <% } %>
                </div>
            </div>
            <% } %>
    </div>
    </div> <!-- Close page-container-blue -->

    <style>
        /* Merged Styles for Clean Cards in Blue Layout */
        .extended-details-section {
            margin-top: 2rem;
        }

        .clean-card {
            background: white;
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            overflow: hidden;
            border: 1px solid #f1f5f9;
        }

        .card-header-clean {
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f8fafc;
            background: white;
        }

        .card-header-clean h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-body-clean {
            padding: 2rem;
        }

        /* Progress Items */
        .progress-items-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .progress-item {
            background: #f8fafc;
            border-radius: 16px;
            padding: 1rem 2rem;
            text-align: center;
            min-width: 120px;
        }

        .item-char {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .text-sm {
            font-size: 1.25rem;
        }

        .item-details {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .item-success .item-char {
            color: #10b981;
        }

        .item-pending .item-char {
            color: #92400e;
        }

        .item-info .item-char {
            color: #3b82f6;
        }

        /* Empty States */
        .empty-placeholder {
            text-align: center;
            padding: 3rem;
            color: #cbd5e1;
        }

        .empty-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
            color: #e2e8f0;
        }

        /* Badges */
        .badge-pill {
            padding: 0.35rem 1rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success-soft {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning-soft {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-primary-soft {
            background: #dbeafe;
            color: #1e40af;
        }
    </style>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Initialize Fonts Defaults
        Chart.defaults.font.family = "'Cairo', sans-serif";
        Chart.defaults.color = '#64748b';

        const childId = '<%= child._id %>';

        async function loadAnalytics() {
            try {
                const response = await fetch(`/specialist/child/${childId}/analytics/data`);
                const data = await response.json();

                if (data.success) {
                    updateHeaderStats(data.stats);
                    createCharts(data.chartData);
                    updateSkillsTable(data.stats.skillsProgress);
                }
            } catch (error) {
                console.error(error);
            }
        }

        function updateHeaderStats(stats) {
            document.getElementById('headerSuccessRate').textContent = stats.successRate + '%';
            document.getElementById('headerAvgScore').textContent = stats.averageScore + '%';
            document.getElementById('headerTotalSessions').textContent = stats.totalSessions;

            const successSuccessfulEl = document.getElementById('successSuccessful');
            const successTotalEl = document.getElementById('successTotal');
            if (successSuccessfulEl && successTotalEl) {
                successSuccessfulEl.textContent = stats.successfulAttempts ?? 0;
                successTotalEl.textContent = stats.totalAttempts ?? 0;
            }
        }

        function createCharts(chartData) {
            // Timeline - Right side usually in RTL but grid flips
            new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: {
                    labels: chartData.timeline.labels,
                    datasets: [{
                        label: 'الدرجة',
                        data: chartData.timeline.data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.05)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, border: { display: false }, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Skills - Left side
            new Chart(document.getElementById('skillsChart'), {
                type: 'bar',
                data: {
                    labels: chartData.skills.labels,
                    datasets: [{
                        label: 'الأداء',
                        data: chartData.skills.data,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4,
                        barThickness: 25
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }, // Matches screenshot: no legend
                    indexAxis: 'y', // Horizontal bars match screenshot style often, or vertical
                    scales: {
                        x: { beginAtZero: true, max: 100, grid: { color: '#f1f5f9' } },
                        y: { grid: { display: false } }
                    }
                }
            });

            // Success
            new Chart(document.getElementById('successChart'), {
                type: 'doughnut',
                data: {
                    labels: chartData.successRate.labels,
                    datasets: [{
                        data: chartData.successRate.data,
                        backgroundColor: ['#10b981', '#f1f5f9'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '75%', plugins: { legend: { display: false } } }
            });

            // Difficulty
            new Chart(document.getElementById('difficultyChart'), {
                type: 'bar',
                data: {
                    labels: ['سهل', 'متوسط', 'صعب'],
                    datasets: [{
                        label: 'حروف',
                        data: [
                            chartData.difficulty?.letters?.easy || 0,
                            chartData.difficulty?.letters?.medium || 0,
                            chartData.difficulty?.letters?.hard || 0
                        ],
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }, {
                        label: 'كلمات',
                        data: [
                            chartData.difficulty?.words?.easy || 0,
                            chartData.difficulty?.words?.medium || 0,
                            chartData.difficulty?.words?.hard || 0
                        ],
                        backgroundColor: '#f59e0b',
                        borderRadius: 4
                    }]
                },
                options: { plugins: { legend: { display: true, labels: { boxWidth: 10 } } } }
            });
        }

        function updateSkillsTable(skills) {
            const tbody = document.querySelector('#skillsTable tbody');
            if (!skills || Object.keys(skills).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">لا توجد بيانات</td></tr>';
                return;
            }
            const names = {
                pronunciation: 'النطق',
                accuracy: 'الدقة',
                fluency: 'الطلاقة',
                completeness: 'الاكتمال'
            };

            tbody.innerHTML = Object.entries(skills).map(([k, v]) => `
            <tr>
                <td>${names[k] || k}</td>
                <td>${v.sessionsCount ?? 0}</td>
                <td>${v.averageScore ?? 0}%</td>
                <td>
                    <div class="table-progress">
                        <div style="width: ${(v.averageScore ?? 0)}%"></div>
                    </div>
                </td>
            </tr>
        `).join('');
        }

        loadAnalytics();
    </script>

    <%- include('../partials/layout-end') %>